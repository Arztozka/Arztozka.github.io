<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель | Магазин</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #3498db;
            color: white;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        input[type="text"], 
        input[type="number"],
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn-save {
            background-color: #27ae60;
            color: white;
            margin-right: 5px;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-add {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .image-preview {
            max-width: 150px;
            max-height: 150px;
            margin-top: 10px;
            display: block;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .product-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #777;
            font-style: italic;
            display: none;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="logout-btn" onclick="logout()">Выйти</button>
        <h1>Админ-панель управления товарами</h1>
        
        <div class="search-box">
            <input type="text" id="search-input" placeholder="Поиск товаров...">
        </div>
        
        <table id="products-table">
            <thead>
                <tr>
                    <th>Изображение</th>
                    <th>Название</th>
                    <th>Описание</th>
                    <th>Цена (₽)</th>
                    <th>Наличие</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="products-list">
                <!-- Товары будут загружаться здесь -->
            </tbody>
        </table>
        
        <div id="no-results" class="no-results">
            Товары не найдены. Добавьте первый товар.
        </div>
        
        <div class="add-form">
            <h2>Добавить новый товар</h2>
            <div class="form-group">
                <label for="product-name">Название товара:</label>
                <input type="text" id="product-name" placeholder="Введите название">
            </div>
            <div class="form-group">
                <label for="product-description">Описание:</label>
                <textarea id="product-description" placeholder="Введите описание"></textarea>
            </div>
            <div class="form-group">
                <label for="product-price">Цена:</label>
                <input type="number" id="product-price" placeholder="Введите цену">
            </div>
            <div class="form-group">
                <label for="product-stock">Количество:</label>
                <input type="number" id="product-stock" placeholder="Введите количество">
            </div>
            <div class="form-group">
                <label for="product-image">Изображение:</label>
                <input type="file" id="product-image" accept="image/*">
                <img id="image-preview" class="image-preview" src="#" alt="Превью" style="display: none;">
            </div>
            <button class="btn btn-add" id="add-product">Добавить товар</button>
        </div>
    </div>

    <script>
        // Проверка авторизации
        if (!sessionStorage.getItem('admin-authenticated')) {
            window.location.href = "index.html";
        }

        // Конфигурация Firebase (замените на свою!)
        const firebaseConfig = {
            apiKey: "AIzaSyBp0UtzwmindIyNXLzdvv4PlUAyLMkD-ig",
            authDomain: "arztozka-f1232.firebaseapp.com",
            databaseURL: "https://arztozka-f1232-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "arztozka-f1232",
            storageBucket: "arztozka-f1232.firebasestorage.app",
            messagingSenderId: "48796655055",
            appId: "1:48796655055:web:2fa9cce80bf18f4eebc6ba"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let products = [];

        // Выход из админки
        function logout() {
            sessionStorage.removeItem('admin-authenticated');
            window.location.href = "index.html";
        }

        // Превью изображения
        document.getElementById('product-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 500 * 1024) { // Ограничение 500KB
                    alert('Изображение должно быть меньше 500KB');
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('image-preview');
                    preview.src = event.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Загрузка товаров
        function loadProducts(searchTerm = '') {
            const productsList = document.getElementById('products-list');
            productsList.innerHTML = '';
            
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (product.description && product.description.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            
            if (filteredProducts.length === 0) {
                document.getElementById('no-results').style.display = 'block';
                document.getElementById('products-table').style.display = 'none';
            } else {
                document.getElementById('no-results').style.display = 'none';
                document.getElementById('products-table').style.display = 'table';
                
                filteredProducts.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            ${product.image ? `<img src="${product.image}" class="product-thumbnail">` : 'Нет изображения'}
                            <input type="file" id="image-upload-${product.id}" style="display: none;" accept="image/*">
                        </td>
                        <td><input type="text" value="${product.name}" id="name-${product.id}"></td>
                        <td><textarea id="description-${product.id}">${product.description || ''}</textarea></td>
                        <td><input type="number" value="${product.price}" id="price-${product.id}"></td>
                        <td><input type="number" value="${product.stock}" id="stock-${product.id}"></td>
                        <td>
                            <button class="btn btn-save" onclick="saveProduct(${product.id})">Сохранить</button>
                            <button class="btn btn-delete" onclick="deleteProduct(${product.id})">Удалить</button>
                        </td>
                    `;
                    productsList.appendChild(row);
                    
                    // Настройка загрузки изображения для существующих товаров
                    const uploadInput = document.getElementById(`image-upload-${product.id}`);
                    const thumbnail = row.querySelector('.product-thumbnail');
                    
                    uploadInput.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file && file.size <= 500 * 1024) {
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                if (thumbnail) {
                                    thumbnail.src = event.target.result;
                                }
                            };
                            reader.readAsDataURL(file);
                        } else if (file) {
                            alert('Изображение должно быть меньше 500KB');
                            this.value = '';
                        }
                    });
                    
                    // Клик по изображению для выбора файла
                    if (thumbnail) {
                        thumbnail.style.cursor = 'pointer';
                        thumbnail.addEventListener('click', () => uploadInput.click());
                    }
                });
            }
        }

        // Сохранение товара
        async function saveProduct(id) {
            const productIndex = products.findIndex(p => p.id === id);
            if (productIndex === -1) return;
            
            const uploadInput = document.getElementById(`image-upload-${id}`);
            const file = uploadInput.files[0];
            let imageData = products[productIndex].image || '';
            
            if (file) {
                imageData = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            }
            
            products[productIndex] = {
                id: id,
                name: document.getElementById(`name-${id}`).value,
                description: document.getElementById(`description-${id}`).value,
                price: document.getElementById(`price-${id}`).value,
                stock: document.getElementById(`stock-${id}`).value,
                image: imageData
            };
            
            database.ref('products').set(products)
                .then(() => alert('Товар успешно обновлен!'))
                .catch(error => alert('Ошибка: ' + error));
        }

        // Удаление товара
        function deleteProduct(id) {
            if (confirm('Вы уверены, что хотите удалить этот товар?')) {
                products = products.filter(p => p.id !== id);
                database.ref('products').set(products)
                    .then(() => {
                        alert('Товар удален!');
                        loadProducts();
                    })
                    .catch(error => alert('Ошибка: ' + error));
            }
        }

        // Добавление товара
        document.getElementById('add-product').addEventListener('click', function() {
            const name = document.getElementById('product-name').value;
            const description = document.getElementById('product-description').value;
            const price = document.getElementById('product-price').value;
            const stock = document.getElementById('product-stock').value;
            const imageInput = document.getElementById('product-image');
            const file = imageInput.files[0];
            
            if (!name || !price || !stock) {
                alert('Пожалуйста, заполните обязательные поля!');
                return;
            }
            
            const processImage = () => {
                return new Promise((resolve) => {
                    if (!file) resolve('');
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            };
            
            processImage().then(imageData => {
                const newId = products.length ? Math.max(...products.map(p => p.id)) + 1 : 1;
                const newProduct = {
                    id: newId,
                    name: name,
                    description: description,
                    price: price,
                    stock: stock,
                    image: imageData
                };
                
                products.push(newProduct);
                database.ref('products').set(products)
                    .then(() => {
                        alert('Товар успешно добавлен!');
                        // Очистка формы
                        document.getElementById('product-name').value = '';
                        document.getElementById('product-description').value = '';
                        document.getElementById('product-price').value = '';
                        document.getElementById('product-stock').value = '';
                        imageInput.value = '';
                        document.getElementById('image-preview').style.display = 'none';
                    })
                    .catch(error => alert('Ошибка: ' + error));
            });
        });
        
        // Поиск товаров
        document.getElementById('search-input').addEventListener('input', function(e) {
            loadProducts(e.target.value);
        });

        // Загрузка данных при старте
        database.ref('products').on('value', (snapshot) => {
            products = snapshot.val() || [];
            loadProducts();
        });
    </script>
</body>
</html>
